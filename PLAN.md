# Keihi 開発プラン

このドキュメントは、Keihi（経費管理アプリケーション）の開発計画を記載しています。

## プロジェクト方針

- **開始方法**: 簡易版の経費管理機能から開始し、後から認証を追加
- **重視する機能**:
  - チーム/組織の経費管理
  - レポート・分析

## 開発フェーズ

### Phase 1: 基本的な経費管理機能（MVP）

**目的**: 認証なしで経費のCRUD操作ができる基本機能を実装

**実装内容**:

#### 1. データベースモデル設計

**Expense（経費）モデル**
- `id`: UUID（主キー）
- `date`: 日付
- `amount`: 金額（Decimal）
- `category`: カテゴリー（外部キー）
- `description`: 説明（テキスト）
- `payment_method`: 支払い方法（現金、クレジットカード、電子マネーなど）
- `created_at`: 作成日時
- `updated_at`: 更新日時

**Category（カテゴリー）モデル**
- `id`: UUID（主キー）
- `name`: カテゴリー名（例: 交通費、会議費、消耗品費）
- `description`: 説明
- `color`: カラーコード（UI表示用）
- `created_at`: 作成日時
- `updated_at`: 更新日時

#### 2. GraphQL API

**Queries（読み取り）**
- `expenses`: 経費一覧取得（ページネーション対応）
- `expense(id: UUID)`: 特定の経費を取得
- `categories`: カテゴリー一覧取得

**Mutations（書き込み）**
- `createExpense(input: ExpenseInput)`: 経費を作成
- `updateExpense(id: UUID, input: ExpenseInput)`: 経費を更新
- `deleteExpense(id: UUID)`: 経費を削除
- `createCategory(input: CategoryInput)`: カテゴリーを作成

#### 3. フロントエンド

**画面構成**
- `/` - ダッシュボード（経費一覧）
- `/expenses/new` - 経費登録フォーム
- `/expenses/:id/edit` - 経費編集フォーム
- `/categories` - カテゴリー管理

**コンポーネント**
- `ExpenseList.vue` - 経費一覧テーブル
- `ExpenseForm.vue` - 経費登録・編集フォーム
- `CategorySelector.vue` - カテゴリー選択ドロップダウン
- `ExpenseCard.vue` - 経費カード表示

**機能**
- 経費の作成・編集・削除
- カテゴリーによるフィルタリング
- 日付によるソート
- レスポンシブデザイン

#### 4. テスト

**バックエンド**
- モデルのユニットテスト
- GraphQL APIの統合テスト
- バリデーションテスト

**フロントエンド**
- コンポーネントのユニットテスト
- GraphQLクエリのモックテスト

**期待される成果物**:
- 動作する経費管理アプリ（認証なし）
- 基本的なテストカバレッジ（70%以上）
- CI/CDパイプラインでのテスト自動化

---

### Phase 2: ユーザー認証とチーム機能

**目的**: 複数ユーザー・チームでの経費管理を可能にする

**実装内容**:

#### 1. 認証・認可

**User（ユーザー）モデル**
- `id`: UUID（主キー）
- `email`: メールアドレス（ユニーク）
- `password`: ハッシュ化されたパスワード
- `first_name`: 名
- `last_name`: 姓
- `role`: ロール（admin, manager, member）
- `is_active`: アクティブフラグ
- `created_at`: 作成日時
- `updated_at`: 更新日時

**実装機能**
- ユーザー登録・ログイン
- JWT認証
- パスワードリセット
- パーミッション管理（ロールベース）

#### 2. チーム/組織モデル

**Organization（組織）モデル**
- `id`: UUID（主キー）
- `name`: 組織名
- `description`: 説明
- `created_at`: 作成日時
- `updated_at`: 更新日時

**Team（チーム）モデル**
- `id`: UUID（主キー）
- `organization`: 組織（外部キー）
- `name`: チーム名
- `description`: 説明
- `created_at`: 作成日時
- `updated_at`: 更新日時

**UserTeamMembership（ユーザー・チーム関連）**
- ユーザーとチームの多対多関係
- ロール（チームリーダー、メンバー）

**Expenseモデルの拡張**
- `user`: 申請者（外部キー）
- `team`: 所属チーム（外部キー）
- `status`: ステータス（下書き、申請中、承認済み、却下）

#### 3. 承認フロー

**ApprovalFlow（承認フロー）モデル**
- `id`: UUID（主キー）
- `expense`: 経費（外部キー）
- `approver`: 承認者（外部キー）
- `status`: 承認ステータス（承認待ち、承認、却下）
- `comment`: コメント
- `approved_at`: 承認日時
- `created_at`: 作成日時

**実装機能**
- 経費申請・承認機能
- 承認ステータス管理
- 通知機能（メール/アプリ内通知）

**期待される成果物**:
- マルチユーザー対応の経費管理システム
- チーム単位での経費管理
- 承認フロー機能

---

### Phase 3: レポート・分析機能

**目的**: 経費の可視化と分析機能を提供

**実装内容**:

#### 1. 集計機能

**GraphQL API拡張**
- `expenseSummary(filter: SummaryFilter)`: 集計データ取得
  - 期間別集計（日別、週別、月別、年別）
  - カテゴリー別集計
  - ユーザー別集計
  - チーム別集計

#### 2. グラフ表示

**フロントエンド実装**
- Chart.js または Recharts を使用
- 月別推移グラフ（折れ線グラフ）
- カテゴリー別円グラフ
- チーム別比較（棒グラフ）
- ダッシュボード画面の充実

#### 3. フィルタリング・検索

**実装機能**
- 日付範囲指定
- カテゴリーフィルター
- 金額範囲検索
- ユーザー・チームフィルター
- 複合検索

**期待される成果物**:
- データ分析ダッシュボード
- カスタマイズ可能なレポート
- エクスポート機能（CSV、PDF）

---

### Phase 4: 領収書機能（オプション）

**目的**: 領収書の添付とOCR機能

**実装内容**:

#### 1. 画像アップロード

**Receipt（領収書）モデル**
- `id`: UUID（主キー）
- `expense`: 経費（外部キー）
- `file_path`: ファイルパス
- `file_name`: ファイル名
- `file_size`: ファイルサイズ
- `content_type`: MIMEタイプ
- `uploaded_at`: アップロード日時

**実装機能**
- 画像アップロード（PNG、JPG、PDF対応）
- クラウドストレージ連携（AWS S3 / Google Cloud Storage）
- サムネイル生成

#### 2. OCR機能（将来的に）

**実装機能**
- Google Cloud Vision API / AWS Textract 連携
- 金額・日付の自動抽出
- 経費フォームへの自動入力

**期待される成果物**:
- 領収書画像の保存・表示機能
- OCRによる自動入力（オプション）

---

## E2Eテスト（Playwright）

各フェーズの完了後、以下のE2Eテストを実装：

**Phase 1テスト**
- 経費の作成・編集・削除フロー
- カテゴリー選択フロー

**Phase 2テスト**
- ログイン・ログアウトフロー
- 経費申請・承認フロー

**Phase 3テスト**
- ダッシュボード表示
- レポート生成フロー

---

## 技術的な考慮事項

### セキュリティ
- JWT認証の実装
- CORS設定の見直し
- CSRFトークンの管理
- 入力値のバリデーション
- SQLインジェクション対策

### パフォーマンス
- データベースインデックスの最適化
- GraphQLのN+1問題対策（DataLoader使用）
- フロントエンドのコード分割
- 画像の最適化

### スケーラビリティ
- データベースのパーティショニング検討
- キャッシュ戦略（Redis検討）
- CDN活用（静的ファイル配信）

---

## マイルストーン

| Phase | 完了予定 | ステータス |
|-------|---------|----------|
| Phase 1 | - | 🔜 次 |
| Phase 2 | - | ⏳ 予定 |
| Phase 3 | - | ⏳ 予定 |
| Phase 4 | - | ⏳ オプション |

---

## 次のステップ

1. **Phase 1の開始**: データベースモデル設計から着手
2. **チーム編成**: 必要に応じて役割分担
3. **スプリント計画**: 週次/隔週でのスプリント設定

このプランは柔軟に調整可能です。開発を進めながら、必要に応じて更新していきます。
